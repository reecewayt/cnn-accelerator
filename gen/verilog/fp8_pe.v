// File: gen/verilog/fp8_pe.v
// Generated by MyHDL 0.11.51
// Date:    Tue May 13 00:36:35 2025 UTC


`timescale 1ns/10ps

module fp8_pe (
    clk,
    i_a,
    i_b,
    i_data_valid,
    i_read_en,
    i_reset,
    i_clear_acc,
    o_c,
    o_mac_done,
    o_ready_for_new
);
// Floating Point Processing Element (FP_PE) using E4M3 format for systolic array architecture.
// Elements see input values simultaneously, latching them when data is valid.
// 
// Parameters:
// - clk: Clock signal
// - i_a, i_b: Input operands (E4M3 format)
// - i_data_valid: Signal indicating valid input data
// - i_read_en: Enable reading of result
// - i_reset: Reset signal
// - i_clear_acc: Signal to clear the accumulator
// - o_c: Output result (E4M3 format)
// - o_mac_done: Signal indicating MAC operation is complete
// - o_ready_for_new: Signal indicating PE is ready for new inputs

input clk;
input [7:0] i_a;
input [7:0] i_b;
input i_data_valid;
input i_read_en;
input i_reset;
input i_clear_acc;
output [7:0] o_c;
wire [7:0] o_c;
output o_mac_done;
wire o_mac_done;
output o_ready_for_new;
wire o_ready_for_new;

wire mac_done;
wire mac_ready;
wire mac_start;
wire [7:0] output_reg;
reg [1:0] fp8_e4m3_mac0_acc_state;
reg [7:0] fp8_e4m3_mac0_accumulator;
reg [7:0] fp8_e4m3_mac0_add_a;
reg [7:0] fp8_e4m3_mac0_add_b;
wire fp8_e4m3_mac0_add_done;
reg fp8_e4m3_mac0_add_pending;
wire [7:0] fp8_e4m3_mac0_add_result;
reg fp8_e4m3_mac0_add_start;
reg [7:0] fp8_e4m3_mac0_mult_a;
reg [7:0] fp8_e4m3_mac0_mult_b;
wire fp8_e4m3_mac0_mult_done;
reg fp8_e4m3_mac0_mult_pending;
wire [7:0] fp8_e4m3_mac0_mult_result;
reg [7:0] fp8_e4m3_mac0_mult_result_reg;
reg fp8_e4m3_mac0_mult_start;
reg [1:0] fp8_e4m3_mac0_mult_state;
reg [7:0] fp8_e4m3_mac0_output_reg;
reg fp8_e4m3_mac0_s_mac_done;
wire fp8_e4m3_mac0_s_ready_for_new;
reg [7:0] fp8_e4m3_mac0_fp8_e4m3_multiply0_a;
reg signed [6:0] fp8_e4m3_mac0_fp8_e4m3_multiply0_a_exp;
reg fp8_e4m3_mac0_fp8_e4m3_multiply0_a_is_nan;
reg fp8_e4m3_mac0_fp8_e4m3_multiply0_a_is_zero;
reg [3:0] fp8_e4m3_mac0_fp8_e4m3_multiply0_a_man;
reg fp8_e4m3_mac0_fp8_e4m3_multiply0_a_sign;
reg [7:0] fp8_e4m3_mac0_fp8_e4m3_multiply0_b;
reg signed [6:0] fp8_e4m3_mac0_fp8_e4m3_multiply0_b_exp;
reg fp8_e4m3_mac0_fp8_e4m3_multiply0_b_is_nan;
reg fp8_e4m3_mac0_fp8_e4m3_multiply0_b_is_zero;
reg [3:0] fp8_e4m3_mac0_fp8_e4m3_multiply0_b_man;
reg fp8_e4m3_mac0_fp8_e4m3_multiply0_b_sign;
reg fp8_e4m3_mac0_fp8_e4m3_multiply0_guard;
reg [7:0] fp8_e4m3_mac0_fp8_e4m3_multiply0_product;
reg fp8_e4m3_mac0_fp8_e4m3_multiply0_round_bit;
reg fp8_e4m3_mac0_fp8_e4m3_multiply0_s_done;
reg [7:0] fp8_e4m3_mac0_fp8_e4m3_multiply0_s_output_z;
reg [2:0] fp8_e4m3_mac0_fp8_e4m3_multiply0_state;
reg fp8_e4m3_mac0_fp8_e4m3_multiply0_sticky;
reg [7:0] fp8_e4m3_mac0_fp8_e4m3_multiply0_z;
reg signed [6:0] fp8_e4m3_mac0_fp8_e4m3_multiply0_z_exp;
reg [5:0] fp8_e4m3_mac0_fp8_e4m3_multiply0_z_man;
reg fp8_e4m3_mac0_fp8_e4m3_multiply0_z_sign;
reg [7:0] fp8_e4m3_mac0_fp8_e4m3_add0_a;
reg signed [4:0] fp8_e4m3_mac0_fp8_e4m3_add0_a_e;
reg [4:0] fp8_e4m3_mac0_fp8_e4m3_add0_a_m;
reg fp8_e4m3_mac0_fp8_e4m3_add0_a_s;
reg [7:0] fp8_e4m3_mac0_fp8_e4m3_add0_b;
reg signed [4:0] fp8_e4m3_mac0_fp8_e4m3_add0_b_e;
reg [4:0] fp8_e4m3_mac0_fp8_e4m3_add0_b_m;
reg fp8_e4m3_mac0_fp8_e4m3_add0_b_s;
reg signed [5:0] fp8_e4m3_mac0_fp8_e4m3_add0_exp_diff;
reg fp8_e4m3_mac0_fp8_e4m3_add0_guard;
wire [3:0] fp8_e4m3_mac0_fp8_e4m3_add0_max_shifts;
reg fp8_e4m3_mac0_fp8_e4m3_add0_round_bit;
reg fp8_e4m3_mac0_fp8_e4m3_add0_s_done;
reg [7:0] fp8_e4m3_mac0_fp8_e4m3_add0_s_output_z;
reg [3:0] fp8_e4m3_mac0_fp8_e4m3_add0_state;
reg fp8_e4m3_mac0_fp8_e4m3_add0_sticky;
reg [5:0] fp8_e4m3_mac0_fp8_e4m3_add0_sum_val;
reg [7:0] fp8_e4m3_mac0_fp8_e4m3_add0_z;
reg signed [4:0] fp8_e4m3_mac0_fp8_e4m3_add0_z_e;
reg [3:0] fp8_e4m3_mac0_fp8_e4m3_add0_z_m;
reg fp8_e4m3_mac0_fp8_e4m3_add0_z_s;

assign fp8_e4m3_mac0_fp8_e4m3_add0_max_shifts = 4'd5;


always @(posedge clk) begin: fp8_e4m3_mac0_fp8_e4m3_multiply0_state_machine
    if (i_reset == 1) begin
        fp8_e4m3_mac0_fp8_e4m3_multiply0_b_man <= 0;
        fp8_e4m3_mac0_fp8_e4m3_multiply0_b_sign <= 0;
        fp8_e4m3_mac0_fp8_e4m3_multiply0_guard <= 0;
        fp8_e4m3_mac0_fp8_e4m3_multiply0_b_exp <= 0;
        fp8_e4m3_mac0_fp8_e4m3_multiply0_a <= 0;
        fp8_e4m3_mac0_fp8_e4m3_multiply0_a_exp <= 0;
        fp8_e4m3_mac0_fp8_e4m3_multiply0_a_is_zero <= 0;
        fp8_e4m3_mac0_fp8_e4m3_multiply0_b_is_zero <= 0;
        fp8_e4m3_mac0_fp8_e4m3_multiply0_sticky <= 0;
        fp8_e4m3_mac0_fp8_e4m3_multiply0_a_sign <= 0;
        fp8_e4m3_mac0_fp8_e4m3_multiply0_s_output_z <= 0;
        fp8_e4m3_mac0_fp8_e4m3_multiply0_b_is_nan <= 0;
        fp8_e4m3_mac0_fp8_e4m3_multiply0_state <= 3'b000;
        fp8_e4m3_mac0_fp8_e4m3_multiply0_z_sign <= 0;
        fp8_e4m3_mac0_fp8_e4m3_multiply0_s_done <= 0;
        fp8_e4m3_mac0_fp8_e4m3_multiply0_a_is_nan <= 0;
        fp8_e4m3_mac0_fp8_e4m3_multiply0_a_man <= 0;
        fp8_e4m3_mac0_fp8_e4m3_multiply0_z <= 0;
        fp8_e4m3_mac0_fp8_e4m3_multiply0_z_exp <= 0;
        fp8_e4m3_mac0_fp8_e4m3_multiply0_round_bit <= 0;
        fp8_e4m3_mac0_fp8_e4m3_multiply0_z_man <= 0;
        fp8_e4m3_mac0_fp8_e4m3_multiply0_b <= 0;
        fp8_e4m3_mac0_fp8_e4m3_multiply0_product <= 0;
    end
    else begin
        if (i_reset) begin
            fp8_e4m3_mac0_fp8_e4m3_multiply0_state <= 3'b000;
            fp8_e4m3_mac0_fp8_e4m3_multiply0_s_done <= 0;
        end
        else begin
            case (fp8_e4m3_mac0_fp8_e4m3_multiply0_state)
                3'b000: begin
                    fp8_e4m3_mac0_fp8_e4m3_multiply0_s_done <= 0;
                    if (fp8_e4m3_mac0_mult_start) begin
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_a <= fp8_e4m3_mac0_mult_a;
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_b <= fp8_e4m3_mac0_mult_b;
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_state <= 3'b001;
                    end
                end
                3'b001: begin
                    fp8_e4m3_mac0_fp8_e4m3_multiply0_a_sign <= (fp8_e4m3_mac0_fp8_e4m3_multiply0_a[(8 - 1)] != 0);
                    fp8_e4m3_mac0_fp8_e4m3_multiply0_a_exp <= (fp8_e4m3_mac0_fp8_e4m3_multiply0_a[(8 - 1)-1:3] - 7);
                    fp8_e4m3_mac0_fp8_e4m3_multiply0_b_sign <= (fp8_e4m3_mac0_fp8_e4m3_multiply0_b[(8 - 1)] != 0);
                    fp8_e4m3_mac0_fp8_e4m3_multiply0_b_exp <= (fp8_e4m3_mac0_fp8_e4m3_multiply0_b[(8 - 1)-1:3] - 7);
                    if ((fp8_e4m3_mac0_fp8_e4m3_multiply0_a[(8 - 1)-1:3] != 0)) begin
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_a_man <= {1'h1, fp8_e4m3_mac0_fp8_e4m3_multiply0_a[3-1:0]};
                    end
                    else begin
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_a_man <= {1'h0, fp8_e4m3_mac0_fp8_e4m3_multiply0_a[3-1:0]};
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_a_exp <= (1 - 7);
                    end
                    if ((fp8_e4m3_mac0_fp8_e4m3_multiply0_b[(8 - 1)-1:3] != 0)) begin
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_b_man <= {1'h1, fp8_e4m3_mac0_fp8_e4m3_multiply0_b[3-1:0]};
                    end
                    else begin
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_b_man <= {1'h0, fp8_e4m3_mac0_fp8_e4m3_multiply0_b[3-1:0]};
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_b_exp <= (1 - 7);
                    end
                    fp8_e4m3_mac0_fp8_e4m3_multiply0_a_is_zero <= ((fp8_e4m3_mac0_fp8_e4m3_multiply0_a[(8 - 1)-1:3] == 0) && (fp8_e4m3_mac0_fp8_e4m3_multiply0_a[3-1:0] == 0));
                    fp8_e4m3_mac0_fp8_e4m3_multiply0_b_is_zero <= ((fp8_e4m3_mac0_fp8_e4m3_multiply0_b[(8 - 1)-1:3] == 0) && (fp8_e4m3_mac0_fp8_e4m3_multiply0_b[3-1:0] == 0));
                    fp8_e4m3_mac0_fp8_e4m3_multiply0_a_is_nan <= (($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_multiply0_a[(8 - 1)-1:3]}) == ((1 << 4) - 1)) && ($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_multiply0_a[3-1:0]}) == ((1 << 3) - 1)));
                    fp8_e4m3_mac0_fp8_e4m3_multiply0_b_is_nan <= (($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_multiply0_b[(8 - 1)-1:3]}) == ((1 << 4) - 1)) && ($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_multiply0_b[3-1:0]}) == ((1 << 3) - 1)));
                    fp8_e4m3_mac0_fp8_e4m3_multiply0_state <= 3'b010;
                end
                3'b010: begin
                    fp8_e4m3_mac0_fp8_e4m3_multiply0_z_sign <= (fp8_e4m3_mac0_fp8_e4m3_multiply0_a_sign ^ fp8_e4m3_mac0_fp8_e4m3_multiply0_b_sign);
                    if ((fp8_e4m3_mac0_fp8_e4m3_multiply0_a_is_nan || fp8_e4m3_mac0_fp8_e4m3_multiply0_b_is_nan)) begin
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_z <= ((((1 << 4) - 1) << 3) | (1 << (3 - 1)));
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_state <= 3'b111;
                    end
                    else if ((fp8_e4m3_mac0_fp8_e4m3_multiply0_a_is_zero || fp8_e4m3_mac0_fp8_e4m3_multiply0_b_is_zero)) begin
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_z <= ($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_multiply0_z_sign}) << (8 - 1));
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_state <= 3'b111;
                    end
                    else begin
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_state <= 3'b011;
                    end
                end
                3'b011: begin
                    if (((fp8_e4m3_mac0_fp8_e4m3_multiply0_a_man[3] == 0) && (fp8_e4m3_mac0_fp8_e4m3_multiply0_a_man != 0))) begin
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_a_man <= (fp8_e4m3_mac0_fp8_e4m3_multiply0_a_man << 1);
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_a_exp <= (fp8_e4m3_mac0_fp8_e4m3_multiply0_a_exp - 1);
                    end
                    else if (((fp8_e4m3_mac0_fp8_e4m3_multiply0_b_man[3] == 0) && (fp8_e4m3_mac0_fp8_e4m3_multiply0_b_man != 0))) begin
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_b_man <= (fp8_e4m3_mac0_fp8_e4m3_multiply0_b_man << 1);
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_b_exp <= (fp8_e4m3_mac0_fp8_e4m3_multiply0_b_exp - 1);
                    end
                    else begin
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_z_exp <= (fp8_e4m3_mac0_fp8_e4m3_multiply0_a_exp + fp8_e4m3_mac0_fp8_e4m3_multiply0_b_exp);
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_product <= (fp8_e4m3_mac0_fp8_e4m3_multiply0_a_man * fp8_e4m3_mac0_fp8_e4m3_multiply0_b_man);
                        if (((fp8_e4m3_mac0_fp8_e4m3_multiply0_a_exp + fp8_e4m3_mac0_fp8_e4m3_multiply0_b_exp) >= (7 + 2))) begin
                            fp8_e4m3_mac0_fp8_e4m3_multiply0_z <= (($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_multiply0_z_sign}) << (8 - 1)) | ((1 << 7) - 2));
                            fp8_e4m3_mac0_fp8_e4m3_multiply0_state <= 3'b111;
                        end
                        else begin
                            fp8_e4m3_mac0_fp8_e4m3_multiply0_state <= 3'b100;
                        end
                    end
                end
                3'b100: begin
                    if (fp8_e4m3_mac0_fp8_e4m3_multiply0_product[((2 * (3 + 1)) - 1)]) begin
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_z_man <= fp8_e4m3_mac0_fp8_e4m3_multiply0_product[((2 * (3 + 1)) - 1)-1:(((2 * (3 + 1)) - 3) - 1)];
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_z_exp <= (fp8_e4m3_mac0_fp8_e4m3_multiply0_z_exp + 1);
                    end
                    else begin
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_z_man <= fp8_e4m3_mac0_fp8_e4m3_multiply0_product[((2 * (3 + 1)) - 2)-1:(((2 * (3 + 1)) - 3) - 2)];
                    end
                    fp8_e4m3_mac0_fp8_e4m3_multiply0_guard <= (fp8_e4m3_mac0_fp8_e4m3_multiply0_product[2] != 0);
                    fp8_e4m3_mac0_fp8_e4m3_multiply0_round_bit <= (fp8_e4m3_mac0_fp8_e4m3_multiply0_product[1] != 0);
                    fp8_e4m3_mac0_fp8_e4m3_multiply0_sticky <= (fp8_e4m3_mac0_fp8_e4m3_multiply0_product[0] != 0);
                    fp8_e4m3_mac0_fp8_e4m3_multiply0_state <= 3'b101;
                end
                3'b101: begin
                    if ((fp8_e4m3_mac0_fp8_e4m3_multiply0_guard && (fp8_e4m3_mac0_fp8_e4m3_multiply0_round_bit || fp8_e4m3_mac0_fp8_e4m3_multiply0_sticky || fp8_e4m3_mac0_fp8_e4m3_multiply0_z_man[0]))) begin
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_z_man <= (fp8_e4m3_mac0_fp8_e4m3_multiply0_z_man + 1);
                        if (($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_multiply0_z_man}) == ((1 << (3 + 1)) - 1))) begin
                            fp8_e4m3_mac0_fp8_e4m3_multiply0_z_exp <= (fp8_e4m3_mac0_fp8_e4m3_multiply0_z_exp + 1);
                        end
                    end
                    fp8_e4m3_mac0_fp8_e4m3_multiply0_state <= 3'b110;
                end
                3'b110: begin
                    if ((fp8_e4m3_mac0_fp8_e4m3_multiply0_z_exp < ((-7) - 3))) begin
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_z <= ($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_multiply0_z_sign}) << (8 - 1));
                    end
                    else if ((fp8_e4m3_mac0_fp8_e4m3_multiply0_z_exp < (-7))) begin
                        if ((((-7) - fp8_e4m3_mac0_fp8_e4m3_multiply0_z_exp) <= 3)) begin
                            fp8_e4m3_mac0_fp8_e4m3_multiply0_z <= (($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_multiply0_z_sign}) << (8 - 1)) | $signed($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_multiply0_z_man}) >>> ((-7) - fp8_e4m3_mac0_fp8_e4m3_multiply0_z_exp))[3-1:0]);
                        end
                        else begin
                            fp8_e4m3_mac0_fp8_e4m3_multiply0_z <= ($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_multiply0_z_sign}) << (8 - 1));
                        end
                    end
                    else if ((fp8_e4m3_mac0_fp8_e4m3_multiply0_z_exp >= (7 + 2))) begin
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_z <= ((($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_multiply0_z_sign}) << (8 - 1)) | (((1 << 4) - 1) << 3)) | ((1 << 3) - 2));
                    end
                    else begin
                        fp8_e4m3_mac0_fp8_e4m3_multiply0_z <= ((($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_multiply0_z_sign}) << (8 - 1)) | ((fp8_e4m3_mac0_fp8_e4m3_multiply0_z_exp + 7) << 3)) | fp8_e4m3_mac0_fp8_e4m3_multiply0_z_man[3-1:0]);
                    end
                    fp8_e4m3_mac0_fp8_e4m3_multiply0_state <= 3'b111;
                end
                3'b111: begin
                    fp8_e4m3_mac0_fp8_e4m3_multiply0_s_output_z <= fp8_e4m3_mac0_fp8_e4m3_multiply0_z;
                    fp8_e4m3_mac0_fp8_e4m3_multiply0_s_done <= 1;
                    fp8_e4m3_mac0_fp8_e4m3_multiply0_state <= 3'b000;
                end
            endcase
        end
    end
end



assign fp8_e4m3_mac0_mult_result = fp8_e4m3_mac0_fp8_e4m3_multiply0_s_output_z;
assign fp8_e4m3_mac0_mult_done = fp8_e4m3_mac0_fp8_e4m3_multiply0_s_done;


always @(posedge clk) begin: fp8_e4m3_mac0_fp8_e4m3_add0_state_machine
    if (i_reset == 1) begin
        fp8_e4m3_mac0_fp8_e4m3_add0_guard <= 0;
        fp8_e4m3_mac0_fp8_e4m3_add0_a <= 0;
        fp8_e4m3_mac0_fp8_e4m3_add0_sticky <= 0;
        fp8_e4m3_mac0_fp8_e4m3_add0_s_output_z <= 0;
        fp8_e4m3_mac0_fp8_e4m3_add0_a_s <= 0;
        fp8_e4m3_mac0_fp8_e4m3_add0_state <= 4'b0000;
        fp8_e4m3_mac0_fp8_e4m3_add0_s_done <= 0;
        fp8_e4m3_mac0_fp8_e4m3_add0_b_s <= 0;
        fp8_e4m3_mac0_fp8_e4m3_add0_b_m <= 0;
        fp8_e4m3_mac0_fp8_e4m3_add0_z_m <= 0;
        fp8_e4m3_mac0_fp8_e4m3_add0_z_s <= 0;
        fp8_e4m3_mac0_fp8_e4m3_add0_a_e <= 0;
        fp8_e4m3_mac0_fp8_e4m3_add0_z <= 0;
        fp8_e4m3_mac0_fp8_e4m3_add0_round_bit <= 0;
        fp8_e4m3_mac0_fp8_e4m3_add0_sum_val <= 0;
        fp8_e4m3_mac0_fp8_e4m3_add0_b_e <= 0;
        fp8_e4m3_mac0_fp8_e4m3_add0_b <= 0;
        fp8_e4m3_mac0_fp8_e4m3_add0_z_e <= 0;
        fp8_e4m3_mac0_fp8_e4m3_add0_exp_diff <= 0;
        fp8_e4m3_mac0_fp8_e4m3_add0_a_m <= 0;
    end
    else begin
        if (i_reset) begin
            fp8_e4m3_mac0_fp8_e4m3_add0_state <= 4'b0000;
            fp8_e4m3_mac0_fp8_e4m3_add0_s_done <= 0;
        end
        else begin
            case (fp8_e4m3_mac0_fp8_e4m3_add0_state)
                4'b0000: begin
                    fp8_e4m3_mac0_fp8_e4m3_add0_s_done <= 0;
                    if (fp8_e4m3_mac0_add_start) begin
                        fp8_e4m3_mac0_fp8_e4m3_add0_a <= fp8_e4m3_mac0_add_a;
                        fp8_e4m3_mac0_fp8_e4m3_add0_b <= fp8_e4m3_mac0_add_b;
                        fp8_e4m3_mac0_fp8_e4m3_add0_state <= 4'b0001;
                    end
                end
                4'b0001: begin
                    fp8_e4m3_mac0_fp8_e4m3_add0_a_s <= (fp8_e4m3_mac0_fp8_e4m3_add0_a[(8 - 1)] != 0);
                    fp8_e4m3_mac0_fp8_e4m3_add0_a_e <= (fp8_e4m3_mac0_fp8_e4m3_add0_a[(8 - 1)-1:3] - 7);
                    fp8_e4m3_mac0_fp8_e4m3_add0_a_m <= 5'h0;
                    fp8_e4m3_mac0_fp8_e4m3_add0_b_s <= (fp8_e4m3_mac0_fp8_e4m3_add0_b[(8 - 1)] != 0);
                    fp8_e4m3_mac0_fp8_e4m3_add0_b_e <= (fp8_e4m3_mac0_fp8_e4m3_add0_b[(8 - 1)-1:3] - 7);
                    fp8_e4m3_mac0_fp8_e4m3_add0_b_m <= 5'h0;
                    if ((fp8_e4m3_mac0_fp8_e4m3_add0_a[(8 - 1)-1:3] != 0)) begin
                        fp8_e4m3_mac0_fp8_e4m3_add0_a_m <= {1'h1, fp8_e4m3_mac0_fp8_e4m3_add0_a[3-1:0], 1'h0};
                    end
                    else begin
                        fp8_e4m3_mac0_fp8_e4m3_add0_a_m <= {1'h0, fp8_e4m3_mac0_fp8_e4m3_add0_a[3-1:0], 1'h0};
                        fp8_e4m3_mac0_fp8_e4m3_add0_a_e <= ((-7) + 1);
                    end
                    if ((fp8_e4m3_mac0_fp8_e4m3_add0_b[(8 - 1)-1:3] != 0)) begin
                        fp8_e4m3_mac0_fp8_e4m3_add0_b_m <= {1'h1, fp8_e4m3_mac0_fp8_e4m3_add0_b[3-1:0], 1'h0};
                    end
                    else begin
                        fp8_e4m3_mac0_fp8_e4m3_add0_b_m <= {1'h0, fp8_e4m3_mac0_fp8_e4m3_add0_b[3-1:0], 1'h0};
                        fp8_e4m3_mac0_fp8_e4m3_add0_b_e <= ((-7) + 1);
                    end
                    if ((($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_add0_a[(8 - 1)-1:3]}) - 7) > ($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_add0_b[(8 - 1)-1:3]}) - 7))) begin
                        fp8_e4m3_mac0_fp8_e4m3_add0_exp_diff <= (($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_add0_a[(8 - 1)-1:3]}) - 7) - ($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_add0_b[(8 - 1)-1:3]}) - 7));
                    end
                    else begin
                        fp8_e4m3_mac0_fp8_e4m3_add0_exp_diff <= (($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_add0_b[(8 - 1)-1:3]}) - 7) - ($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_add0_a[(8 - 1)-1:3]}) - 7));
                    end
                    fp8_e4m3_mac0_fp8_e4m3_add0_state <= 4'b0010;
                end
                4'b0010: begin
                    if (((($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_add0_a[(8 - 1)-1:3]}) == ((1 << 4) - 1)) && ($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_add0_a[3-1:0]}) == ((1 << 3) - 1))) || (($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_add0_b[(8 - 1)-1:3]}) == ((1 << 4) - 1)) && ($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_add0_b[3-1:0]}) == ((1 << 3) - 1))))) begin
                        fp8_e4m3_mac0_fp8_e4m3_add0_z <= ((($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_add0_z_s}) << (8 - 1)) | (((1 << 4) - 1) << 3)) | ((1 << 3) - 1));
                        fp8_e4m3_mac0_fp8_e4m3_add0_state <= 4'b1010;
                    end
                    else if (((fp8_e4m3_mac0_fp8_e4m3_add0_a[(8 - 1)-1:3] == 0) && (fp8_e4m3_mac0_fp8_e4m3_add0_a[3-1:0] == 0))) begin
                        if (((fp8_e4m3_mac0_fp8_e4m3_add0_b[(8 - 1)-1:3] == 0) && (fp8_e4m3_mac0_fp8_e4m3_add0_b[3-1:0] == 0))) begin
                            fp8_e4m3_mac0_fp8_e4m3_add0_z <= ((fp8_e4m3_mac0_fp8_e4m3_add0_a_s & fp8_e4m3_mac0_fp8_e4m3_add0_b_s) << (8 - 1));
                        end
                        else begin
                            fp8_e4m3_mac0_fp8_e4m3_add0_z <= fp8_e4m3_mac0_fp8_e4m3_add0_b;
                        end
                        fp8_e4m3_mac0_fp8_e4m3_add0_state <= 4'b1010;
                    end
                    else if (((fp8_e4m3_mac0_fp8_e4m3_add0_b[(8 - 1)-1:3] == 0) && (fp8_e4m3_mac0_fp8_e4m3_add0_b[3-1:0] == 0))) begin
                        fp8_e4m3_mac0_fp8_e4m3_add0_z <= fp8_e4m3_mac0_fp8_e4m3_add0_a;
                        fp8_e4m3_mac0_fp8_e4m3_add0_state <= 4'b1010;
                    end
                    else if ((((($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_add0_a[(8 - 1)-1:3]}) == ((1 << 4) - 1)) && ($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_add0_a[3-1:0]}) == ((1 << 3) - 2))) || (($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_add0_b[(8 - 1)-1:3]}) == ((1 << 4) - 1)) && ($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_add0_b[3-1:0]}) == ((1 << 3) - 2)))) && (fp8_e4m3_mac0_fp8_e4m3_add0_a_s == fp8_e4m3_mac0_fp8_e4m3_add0_b_s))) begin
                        fp8_e4m3_mac0_fp8_e4m3_add0_z <= ((((fp8_e4m3_mac0_fp8_e4m3_add0_a_s & fp8_e4m3_mac0_fp8_e4m3_add0_b_s) << (8 - 1)) | (((1 << 4) - 1) << 3)) | ((1 << 3) - 2));
                        fp8_e4m3_mac0_fp8_e4m3_add0_state <= 4'b1010;
                    end
                    else begin
                        fp8_e4m3_mac0_fp8_e4m3_add0_state <= 4'b0011;
                    end
                end
                4'b0011: begin
                    if ((fp8_e4m3_mac0_fp8_e4m3_add0_a_e > fp8_e4m3_mac0_fp8_e4m3_add0_b_e)) begin
                        if ((fp8_e4m3_mac0_fp8_e4m3_add0_exp_diff > $signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_add0_max_shifts}))) begin
                            fp8_e4m3_mac0_fp8_e4m3_add0_z <= fp8_e4m3_mac0_fp8_e4m3_add0_a;
                            fp8_e4m3_mac0_fp8_e4m3_add0_state <= 4'b1010;
                        end
                        else begin
                            fp8_e4m3_mac0_fp8_e4m3_add0_b_e <= (fp8_e4m3_mac0_fp8_e4m3_add0_b_e + 1);
                            fp8_e4m3_mac0_fp8_e4m3_add0_b_m <= (fp8_e4m3_mac0_fp8_e4m3_add0_b_m >>> 1);
                            if (fp8_e4m3_mac0_fp8_e4m3_add0_b_m[0]) begin
                                fp8_e4m3_mac0_fp8_e4m3_add0_b_m[0] <= 1;
                            end
                        end
                    end
                    else if ((fp8_e4m3_mac0_fp8_e4m3_add0_a_e < fp8_e4m3_mac0_fp8_e4m3_add0_b_e)) begin
                        if ((fp8_e4m3_mac0_fp8_e4m3_add0_exp_diff > $signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_add0_max_shifts}))) begin
                            fp8_e4m3_mac0_fp8_e4m3_add0_z <= fp8_e4m3_mac0_fp8_e4m3_add0_b;
                            fp8_e4m3_mac0_fp8_e4m3_add0_state <= 4'b1010;
                        end
                        else begin
                            fp8_e4m3_mac0_fp8_e4m3_add0_a_e <= (fp8_e4m3_mac0_fp8_e4m3_add0_a_e + 1);
                            fp8_e4m3_mac0_fp8_e4m3_add0_a_m <= (fp8_e4m3_mac0_fp8_e4m3_add0_a_m >>> 1);
                            if (fp8_e4m3_mac0_fp8_e4m3_add0_a_m[0]) begin
                                fp8_e4m3_mac0_fp8_e4m3_add0_a_m[0] <= 1;
                            end
                        end
                    end
                    else begin
                        fp8_e4m3_mac0_fp8_e4m3_add0_state <= 4'b0100;
                    end
                end
                4'b0100: begin
                    fp8_e4m3_mac0_fp8_e4m3_add0_z_e <= fp8_e4m3_mac0_fp8_e4m3_add0_a_e;
                    if ((fp8_e4m3_mac0_fp8_e4m3_add0_a_s == fp8_e4m3_mac0_fp8_e4m3_add0_b_s)) begin
                        fp8_e4m3_mac0_fp8_e4m3_add0_sum_val <= (fp8_e4m3_mac0_fp8_e4m3_add0_a_m + fp8_e4m3_mac0_fp8_e4m3_add0_b_m);
                        fp8_e4m3_mac0_fp8_e4m3_add0_z_s <= fp8_e4m3_mac0_fp8_e4m3_add0_a_s;
                    end
                    else begin
                        if ((fp8_e4m3_mac0_fp8_e4m3_add0_a_m >= fp8_e4m3_mac0_fp8_e4m3_add0_b_m)) begin
                            fp8_e4m3_mac0_fp8_e4m3_add0_sum_val <= (fp8_e4m3_mac0_fp8_e4m3_add0_a_m - fp8_e4m3_mac0_fp8_e4m3_add0_b_m);
                            fp8_e4m3_mac0_fp8_e4m3_add0_z_s <= fp8_e4m3_mac0_fp8_e4m3_add0_a_s;
                        end
                        else begin
                            fp8_e4m3_mac0_fp8_e4m3_add0_sum_val <= (fp8_e4m3_mac0_fp8_e4m3_add0_b_m - fp8_e4m3_mac0_fp8_e4m3_add0_a_m);
                            fp8_e4m3_mac0_fp8_e4m3_add0_z_s <= fp8_e4m3_mac0_fp8_e4m3_add0_b_s;
                        end
                    end
                    fp8_e4m3_mac0_fp8_e4m3_add0_state <= 4'b0101;
                end
                4'b0101: begin
                    if (fp8_e4m3_mac0_fp8_e4m3_add0_sum_val[(3 + 2)]) begin
                        fp8_e4m3_mac0_fp8_e4m3_add0_z_m <= fp8_e4m3_mac0_fp8_e4m3_add0_sum_val[(3 + 3)-1:2];
                        fp8_e4m3_mac0_fp8_e4m3_add0_guard <= (fp8_e4m3_mac0_fp8_e4m3_add0_sum_val[1] != 0);
                        fp8_e4m3_mac0_fp8_e4m3_add0_round_bit <= (fp8_e4m3_mac0_fp8_e4m3_add0_sum_val[0] != 0);
                        fp8_e4m3_mac0_fp8_e4m3_add0_sticky <= 1'b0;
                        fp8_e4m3_mac0_fp8_e4m3_add0_z_e <= (fp8_e4m3_mac0_fp8_e4m3_add0_z_e + 1);
                    end
                    else begin
                        fp8_e4m3_mac0_fp8_e4m3_add0_z_m <= fp8_e4m3_mac0_fp8_e4m3_add0_sum_val[(3 + 2)-1:1];
                        fp8_e4m3_mac0_fp8_e4m3_add0_guard <= (fp8_e4m3_mac0_fp8_e4m3_add0_sum_val[0] != 0);
                        fp8_e4m3_mac0_fp8_e4m3_add0_round_bit <= 1'b0;
                        fp8_e4m3_mac0_fp8_e4m3_add0_sticky <= 1'b0;
                    end
                    fp8_e4m3_mac0_fp8_e4m3_add0_state <= 4'b0110;
                end
                4'b0110: begin
                    if (((fp8_e4m3_mac0_fp8_e4m3_add0_z_m[3] == 0) && (fp8_e4m3_mac0_fp8_e4m3_add0_z_e > ((-7) + 1)))) begin
                        fp8_e4m3_mac0_fp8_e4m3_add0_z_e <= (fp8_e4m3_mac0_fp8_e4m3_add0_z_e - 1);
                        fp8_e4m3_mac0_fp8_e4m3_add0_z_m <= (fp8_e4m3_mac0_fp8_e4m3_add0_z_m << 1);
                        fp8_e4m3_mac0_fp8_e4m3_add0_z_m[0] <= fp8_e4m3_mac0_fp8_e4m3_add0_guard;
                        fp8_e4m3_mac0_fp8_e4m3_add0_guard <= fp8_e4m3_mac0_fp8_e4m3_add0_round_bit;
                        fp8_e4m3_mac0_fp8_e4m3_add0_round_bit <= 1'b0;
                    end
                    else begin
                        fp8_e4m3_mac0_fp8_e4m3_add0_state <= 4'b0111;
                    end
                end
                4'b0111: begin
                    if ((fp8_e4m3_mac0_fp8_e4m3_add0_z_e < ((-7) + 1))) begin
                        fp8_e4m3_mac0_fp8_e4m3_add0_z_e <= (fp8_e4m3_mac0_fp8_e4m3_add0_z_e + 1);
                        fp8_e4m3_mac0_fp8_e4m3_add0_guard <= fp8_e4m3_mac0_fp8_e4m3_add0_z_m[0];
                        fp8_e4m3_mac0_fp8_e4m3_add0_z_m <= (fp8_e4m3_mac0_fp8_e4m3_add0_z_m >>> 1);
                        fp8_e4m3_mac0_fp8_e4m3_add0_round_bit <= fp8_e4m3_mac0_fp8_e4m3_add0_guard;
                        fp8_e4m3_mac0_fp8_e4m3_add0_sticky <= (fp8_e4m3_mac0_fp8_e4m3_add0_sticky | fp8_e4m3_mac0_fp8_e4m3_add0_round_bit);
                    end
                    else begin
                        fp8_e4m3_mac0_fp8_e4m3_add0_state <= 4'b1000;
                    end
                end
                4'b1000: begin
                    if ((fp8_e4m3_mac0_fp8_e4m3_add0_guard && (fp8_e4m3_mac0_fp8_e4m3_add0_round_bit || fp8_e4m3_mac0_fp8_e4m3_add0_sticky || fp8_e4m3_mac0_fp8_e4m3_add0_z_m[0]))) begin
                        fp8_e4m3_mac0_fp8_e4m3_add0_z_m <= (fp8_e4m3_mac0_fp8_e4m3_add0_z_m + 1);
                        if (($signed({1'b0, fp8_e4m3_mac0_fp8_e4m3_add0_z_m}) == ((1 << 3) - 1))) begin
                            fp8_e4m3_mac0_fp8_e4m3_add0_z_e <= (fp8_e4m3_mac0_fp8_e4m3_add0_z_e + 1);
                        end
                    end
                    fp8_e4m3_mac0_fp8_e4m3_add0_state <= 4'b1001;
                end
                4'b1001: begin
                    fp8_e4m3_mac0_fp8_e4m3_add0_z[3-1:0] <= fp8_e4m3_mac0_fp8_e4m3_add0_z_m[3-1:0];
                    fp8_e4m3_mac0_fp8_e4m3_add0_z[(8 - 1)-1:3] <= (fp8_e4m3_mac0_fp8_e4m3_add0_z_e + 7);
                    fp8_e4m3_mac0_fp8_e4m3_add0_z[(8 - 1)] <= fp8_e4m3_mac0_fp8_e4m3_add0_z_s;
                    if (((fp8_e4m3_mac0_fp8_e4m3_add0_z_e == ((-7) + 1)) && (fp8_e4m3_mac0_fp8_e4m3_add0_z_m[3] == 0))) begin
                        fp8_e4m3_mac0_fp8_e4m3_add0_z[(8 - 1)-1:3] <= 0;
                    end
                    if (((fp8_e4m3_mac0_fp8_e4m3_add0_z_e <= ((-7) + 1)) && (fp8_e4m3_mac0_fp8_e4m3_add0_z_m == 0))) begin
                        fp8_e4m3_mac0_fp8_e4m3_add0_z[(8 - 1)] <= 0;
                    end
                    if ((fp8_e4m3_mac0_fp8_e4m3_add0_z_e >= 7)) begin
                        fp8_e4m3_mac0_fp8_e4m3_add0_z[(8 - 1)-1:3] <= ((1 << 4) - 1);
                        fp8_e4m3_mac0_fp8_e4m3_add0_z[3-1:0] <= ((1 << 3) - 2);
                    end
                    fp8_e4m3_mac0_fp8_e4m3_add0_state <= 4'b1010;
                end
                4'b1010: begin
                    fp8_e4m3_mac0_fp8_e4m3_add0_s_output_z <= fp8_e4m3_mac0_fp8_e4m3_add0_z;
                    fp8_e4m3_mac0_fp8_e4m3_add0_s_done <= 1;
                    fp8_e4m3_mac0_fp8_e4m3_add0_state <= 4'b0000;
                end
            endcase
        end
    end
end



assign fp8_e4m3_mac0_add_result = fp8_e4m3_mac0_fp8_e4m3_add0_s_output_z;
assign fp8_e4m3_mac0_add_done = fp8_e4m3_mac0_fp8_e4m3_add0_s_done;


always @(posedge clk) begin: fp8_e4m3_mac0_multiply_pipeline
    if (i_reset == 1) begin
        fp8_e4m3_mac0_mult_b <= 0;
        fp8_e4m3_mac0_mult_state <= 2'b00;
        fp8_e4m3_mac0_mult_start <= 0;
        fp8_e4m3_mac0_mult_result_reg <= 0;
        fp8_e4m3_mac0_mult_a <= 0;
    end
    else begin
        if (i_reset) begin
            fp8_e4m3_mac0_mult_state <= 2'b00;
        end
        else begin
            case (fp8_e4m3_mac0_mult_state)
                2'b00: begin
                    if (mac_start) begin
                        fp8_e4m3_mac0_mult_a <= i_a;
                        fp8_e4m3_mac0_mult_b <= i_b;
                        fp8_e4m3_mac0_mult_state <= 2'b01;
                    end
                end
                2'b01: begin
                    fp8_e4m3_mac0_mult_start <= 1;
                    fp8_e4m3_mac0_mult_state <= 2'b10;
                end
                2'b10: begin
                    fp8_e4m3_mac0_mult_start <= 0;
                    if (fp8_e4m3_mac0_mult_done) begin
                        fp8_e4m3_mac0_mult_result_reg <= fp8_e4m3_mac0_mult_result;
                        fp8_e4m3_mac0_mult_state <= 2'b00;
                    end
                end
            endcase
        end
    end
end


always @(posedge clk) begin: fp8_e4m3_mac0_accumulate_pipeline
    if (i_reset == 1) begin
        fp8_e4m3_mac0_s_mac_done <= 0;
        fp8_e4m3_mac0_accumulator <= 0;
        fp8_e4m3_mac0_add_start <= 0;
        fp8_e4m3_mac0_add_pending <= 0;
        fp8_e4m3_mac0_add_a <= 0;
        fp8_e4m3_mac0_acc_state <= 2'b00;
        fp8_e4m3_mac0_add_b <= 0;
    end
    else begin
        if (i_reset) begin
            fp8_e4m3_mac0_acc_state <= 2'b00;
            fp8_e4m3_mac0_accumulator <= 0;
            fp8_e4m3_mac0_add_pending <= 0;
            fp8_e4m3_mac0_s_mac_done <= 0;
        end
        else begin
            fp8_e4m3_mac0_s_mac_done <= 0;
            case (fp8_e4m3_mac0_acc_state)
                2'b00: begin
                    if (i_clear_acc) begin
                        fp8_e4m3_mac0_accumulator <= 0;
                        fp8_e4m3_mac0_add_pending <= 0;
                    end
                    else if ((fp8_e4m3_mac0_mult_pending && (!fp8_e4m3_mac0_add_pending))) begin
                        fp8_e4m3_mac0_add_a <= fp8_e4m3_mac0_mult_result_reg;
                        fp8_e4m3_mac0_add_b <= fp8_e4m3_mac0_accumulator;
                        fp8_e4m3_mac0_add_pending <= 1;
                        fp8_e4m3_mac0_acc_state <= 2'b01;
                    end
                end
                2'b01: begin
                    fp8_e4m3_mac0_add_start <= 1;
                    fp8_e4m3_mac0_acc_state <= 2'b10;
                end
                2'b10: begin
                    fp8_e4m3_mac0_add_start <= 0;
                    if (fp8_e4m3_mac0_add_done) begin
                        fp8_e4m3_mac0_acc_state <= 2'b11;
                    end
                end
                2'b11: begin
                    fp8_e4m3_mac0_accumulator <= fp8_e4m3_mac0_add_result;
                    fp8_e4m3_mac0_add_pending <= 0;
                    fp8_e4m3_mac0_s_mac_done <= 1;
                    fp8_e4m3_mac0_acc_state <= 2'b00;
                end
            endcase
        end
    end
end


always @(posedge clk) begin: fp8_e4m3_mac0_mult_pending_control
    if (i_reset == 1) begin
        fp8_e4m3_mac0_mult_pending <= 0;
    end
    else begin
        if (i_reset) begin
            fp8_e4m3_mac0_mult_pending <= 0;
        end
        else begin
            if (((fp8_e4m3_mac0_mult_state == 2'b10) && fp8_e4m3_mac0_mult_done)) begin
                fp8_e4m3_mac0_mult_pending <= 1;
            end
            else if ((fp8_e4m3_mac0_acc_state == 2'b11)) begin
                fp8_e4m3_mac0_mult_pending <= 0;
            end
            else if (i_clear_acc) begin
                fp8_e4m3_mac0_mult_pending <= 0;
            end
        end
    end
end


always @(posedge clk) begin: fp8_e4m3_mac0_output_control
    if (i_reset == 1) begin
        fp8_e4m3_mac0_output_reg <= 0;
    end
    else begin
        if (i_reset) begin
            fp8_e4m3_mac0_output_reg <= 0;
        end
        else begin
            if (i_read_en) begin
                fp8_e4m3_mac0_output_reg <= fp8_e4m3_mac0_accumulator;
            end
        end
    end
end



assign output_reg = fp8_e4m3_mac0_output_reg;
assign mac_done = fp8_e4m3_mac0_s_mac_done;
assign fp8_e4m3_mac0_s_ready_for_new = ((fp8_e4m3_mac0_mult_state == 2'b00) && (!fp8_e4m3_mac0_mult_pending));
assign mac_ready = fp8_e4m3_mac0_s_ready_for_new;

// Control logic for the MAC unit

assign mac_start = (i_data_valid && mac_ready);
assign o_mac_done = mac_done;
assign o_ready_for_new = mac_ready;

// Connect the MAC output to the PE output

assign o_c = output_reg;

endmodule
